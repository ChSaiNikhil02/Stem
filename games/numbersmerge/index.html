<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Number Merge Game (2048)</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
    <button onclick="window.location.href='/math.html'" style="position: absolute; top: 10px; left: 10px; z-index: 1000; padding: 10px 15px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">&larr; Back</button>
  <h1>Number Merge Game (2048)</h1>
  <div id="game-container"></div>
  <div class="game-info">
    <div class="score-container">
      SCORE : <span id="score">0</span>
    </div>
    <button id="reset-button">Reset</button>
  </div>
  <p id="status"></p>

  <script>
    const SIZE = 4;
    let board = [];
    let score = 0;

    const colors = {
      0: ["#cdc1b4", "#776e65"],
      2: ["#eee4da", "#776e65"],
      4: ["#ede0c8", "#776e65"],
      8: ["#f2b179", "#f9f6f2"],
      16: ["#f59563", "#f9f6f2"],
      32: ["#f67c5f", "#f9f6f2"],
      64: ["#f65e3b", "#f9f6f2"],
      128: ["#edcf72", "#f9f6f2"],
      256: ["#edcc61", "#f9f6f2"],
      512: ["#edc850", "#f9f6f2"],
      1024: ["#edc53f", "#f9f6f2"],
      2048: ["#edc22e", "#f9f6f2"]
    };

    function initBoard() {
      board = Array.from({ length: SIZE }, () => Array(SIZE).fill(0));
      score = 0;
      document.getElementById('score').textContent = score;
      addTile();
      addTile();
      render();
    }

    function addTile() {
      let empty = [];
      for (let i = 0; i < SIZE; i++) {
        for (let j = 0; j < SIZE; j++) {
          if (board[i][j] === 0) empty.push([i, j]);
        }
      }
      if (empty.length > 0) {
        let [x, y] = empty[Math.floor(Math.random() * empty.length)];
        board[x][y] = Math.random() < 0.9 ? 2 : 4;
      }
    }

    function render() {
      const container = document.getElementById("game-container");
      container.innerHTML = "";
      for (let i = 0; i < SIZE; i++) {
        for (let j = 0; j < SIZE; j++) {
          const value = board[i][j];
          const cell = document.createElement("div");
          cell.classList.add("cell");
          cell.textContent = value === 0 ? "" : value;
          cell.style.background = colors[value] ? colors[value][0] : "#3c3a32";
          cell.style.color = colors[value] ? colors[value][1] : "#f9f6f2";
          container.appendChild(cell);
        }
      }
      document.getElementById('score').textContent = (score / 50).toFixed(2);
    }

    function compress(row) {
      let newRow = row.filter(v => v !== 0);
      while (newRow.length < SIZE) newRow.push(0);
      return newRow;
    }

    function merge(row) {
      for (let i = 0; i < SIZE - 1; i++) {
        if (row[i] !== 0 && row[i] === row[i + 1]) {
          row[i] *= 2;
          score += row[i];
          row[i + 1] = 0;
        }
      }
      return row;
    }

function moveLeft() {
  let newBoard = [];
  for (let row of board) {
    row = compress(row);
    row = merge(row);
    row = compress(row);
    newBoard.push(row);
  }
  board = newBoard;
}

function reverse(board) {
  return board.map(row => row.reverse());
}

function transpose(board) {
  return board[0].map((_, colIndex) => board.map(row => row[colIndex]));
}

function moveRight() {
  board = reverse(board);
  moveLeft();
  board = reverse(board);
}

function moveUp() {
  board = transpose(board);
  moveLeft();
  board = transpose(board);
}

function moveDown() {
  board = transpose(board);
  moveRight();
  board = transpose(board);
}

function canMove() {
  for (let i = 0; i < SIZE; i++) {
    for (let j = 0; j < SIZE; j++) {
      if (board[i][j] === 0) return true;
      if (j + 1 < SIZE && board[i][j] === board[i][j + 1]) return true;
      if (i + 1 < SIZE && board[i][j] === board[i + 1][j]) return true;
    }
  }
  return false;
}

function handleMove(direction) {
  let oldBoard = JSON.stringify(board);

  if (direction === "ArrowLeft") moveLeft();
  else if (direction === "ArrowRight") moveRight();
  else if (direction === "ArrowUp") moveUp();
  else if (direction === "ArrowDown") moveDown();

  if (JSON.stringify(board) !== oldBoard) {
    addTile();
    render();
  }

  if (!canMove()) {
    document.getElementById("status").textContent = "Game Over!";
    saveScore(score);
    document.removeEventListener("keydown", keyHandler);
  }
}

async function saveScore(originalScore) { // Renamed parameter for clarity
  const dividedScore = (originalScore / 50).toFixed(2);
  try {
    const response = await fetch('/save-score', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ score: dividedScore, subject: 'math' }), // Send dividedScore
    });
    if (response.ok) {
      console.log('Score saved successfully');
    } else {
      console.error('Failed to save score');
    }
  } catch (error) {
    console.error('Error saving score:', error);
  }
}

function keyHandler(e) {
  if (["ArrowLeft", "ArrowRight", "ArrowUp", "ArrowDown"].includes(e.key)) {
    e.preventDefault();
    handleMove(e.key);
  }
}

document.addEventListener("keydown", keyHandler);
document.getElementById("reset-button").addEventListener("click", () => {
  document.getElementById("status").textContent = "";
  initBoard();
});

initBoard();

  </script>
</body>
</html>
